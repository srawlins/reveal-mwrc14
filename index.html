<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>ObjectSpace.trace_object_allocations</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/default.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css" disabled="true">
    <link rel="stylesheet" href="lib/css/tomorrow-night-bright.css">
    <link rel="stylesheet" href="css/custom.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
<section data-state="default">
  <h1>Ruby 2.1</h1>
  <h2>Tracing Object Allocations</h2>
  <p>
    <small>Sam Rawlins / <a href="https://www.github.com/srawlins">@srawlins</a></small>
  </p>
</section>

<section data-state="default">
  <h2>Ruby 2.1.0-preview1 is out!</h2>
  <ul style="list-style-type: none;">
    <li class="fragment"><code>$ rbenv install 2.1.0-preview1</code></li>
    <li class="fragment"><code>$ rvm install ruby-2.1.0-preview1</code></li>
  </ul>
</section>

<section data-state="default" class="no-shadow">
  <h2>Ruby 2.1 <span style="font-variant: small-caps">news</span></h2>
  <pre class="news">
= NEWS for Ruby 2.1.0

This document is a list of user visible feature changes made between
releases except for bug fixes.

Note that each entry is kept so brief that no reason behind or
reference information is supplied with.  For a full list of changes
with all sufficient information, see the ChangeLog file.

== Changes since the 2.0.0 release

=== Language changes

* Now the default values of keyword arguments can be omitted.  Those
  "required keyword arguments" need giving explicitly at the call time.

* Added suffixes for integer and float literals: 'r', 'i', and 'ri'.
  * "42r" and "3.14r" are evaluated as Rational(42, 1) and 3.14.rationalize,
    respectively.  But exponential form with 'r' suffix like "6.022e+23r" is
    not accepted because it is misleading.
  * "42i" and "3.14i" are evaluated as Complex(0, 42) and Complex(0, 3.14),
    respectively.
  * "42ri" and "3.14ri" are evaluated as Complex(0, 42r) and Complex(0, 3.14r),
    respectively.

* def-expr now returns the symbol of its name instead of nil.

* Added 'f' suffix for string literals that returns a frozen String object.

=== Core classes updates (outstanding ones only)

* Binding
  * New methods
    * Binding#local_variable_get(symbol)
    * Binding#local_variable_set(symbol, obj)
    * Binding#local_variable_defined?(symbol)

* GC
  * added environment variable:
    * RUBY_HEAP_SLOTS_GROWTH_FACTOR: growth rate of the heap.

* Integer
  * New methods
    * Fixnum#bit_length
    * Bignum#bit_length
  * Bignum performance improvement
    * Use GMP if available.
      GMP is used only for several operations:
      multiplication, division, radix conversion, GCD

* IO
  * extended methods:
    * IO#seek supports SEEK_DATA and SEEK_HOLE as whence.
    * IO#seek accepts symbols (:CUR, :END, :SET, :DATA, :HOLE) for 2nd argument.
    * IO#read_nonblock accepts optional `exception: false` to return symbols
    * IO#write_nonblock accepts optional `exception: false` to return symbols

* Kernel
  * New methods:
    * Kernel#singleton_method

* Module
  * New methods:
    * Module#using, which activates refinements of the specified module only
      in the current class or module definition.
    * Module#singleton_class? returns true if the receiver is a singleton class
      or false if it is an ordinary class or module.
  * extended methods:
    * Module#refine is no longer experimental.
    * Module#include and Module#prepend are now public methods.

* Mutex
  * misc
    * Mutex#owned? is no longer experimental.

* Numeric
  * extended methods:
    * Numeric#step allows the limit argument to be omitted, in which
      case an infinite sequence of numbers is generated.  Keyword
      arguments `to` and `by` are introduced for ease of use.

* Process
  * New methods:
    * alternative methods to $0/$0=:
      * Process.argv0() returns the original value of $0.
      * Process.setproctitle() sets the process title without affecting $0.
    * Process.clock_gettime
    * Process.clock_getres

* RbConfig
  * New constants:
    * RbConfig::SIZEOF is added to provide the size of C types.

* String
  * New methods:
    * String#scrub and String#scrub! verify and fix invalid byte sequence.
  * extended methods:
    * If invalid: :replace is specified for String#encode, replace
      invalid byte sequence even if the destination encoding equals to
      the source encoding.

* Symbol
  * All symbols are now frozen.

* pack/unpack (Array/String)
  * Q! and q! directives for long long type if platform has the type.

* toplevel
  * extended methods:
    * main.using is no longer experimental. The method activates refinements
      in the ancestors of the argument module to support refinement
      inheritance by Module#include.

=== Core classes compatibility issues (excluding feature bug fixes)

* IO
  * incompatible changes:
    * open ignore internal encoding if external encoding is ASCII-8BIT.

* Kernel#eval, Kernel#instance_eval, and Module#module_eval.
  * Copies the scope information of the original environment, which means
    that private, protected, public, and module_function without arguments
    do not affect the environment outside the eval string.
    For example, `class Foo; eval "private"; def foo; end; end' doesn't make
    Foo#foo private.

* Kernel#untrusted?, untrust, and trust
  * These methods are deprecated and their behavior is same as tainted?,
    taint, and untaint, respectively.  If $VERBOSE is true, they show warnings.

* Module#ancestors
  * The ancestors of a singleton class now include singleton classes,
    in particular itself.

* Module#define_method and Object#define_singleton_method
  * Now they return the symbols of the defined methods, not the methods/procs
    themselves.

* Numeric#quo
  * Raises TypeError instead of ArgumentError if the receiver doesn't have
    to_r method.

* Proc
  * Returning from lambda proc now always exits from the Proc, not from the
    method where the lambda is created.  Returing from non-lambda proc exits
    from the method, same as the former behavior.


=== Stdlib updates (outstanding ones only)

* CGI::Util
  * All class methods modulized.

* Digest
  * extended methods:
    * Digest::Class.file takes optional arguments for its constructor

* Matrix
  * Added Vector#cross_product.

* Net::SMTP
  * Added Net::SMTP#rset to implement the RSET command

* Pathname
  * New methods:
    * Pathname#write
    * Pathname#binwrite

* OpenSSL::BN
  * extended methods:
    * OpenSSL::BN.new allows Fixnum/Bignum argument.

* open-uri
  * Support multiple fields with same field name (like Set-Cookie).

* RDoc
  * Updated to 4.1.0.preview.1.  Major enhancements include a modified default
    template and accessibility enhancements.

    For a list of minor enhancements and bug fixes see:
    https://github.com/rdoc/rdoc/blob/v4.1.0.preview.1/History.rdoc

* Resolv
  * New methods:
    * Resolv::DNS.fetch_resource
  * One-shot multicast DNS support
  * Support LOC resources

* REXML::Parsers::SAX2Parser
  * Fixes wrong number of arguments of entitydecl event. Document of the event
    says "an array of the entity declaration" but implemenation passes two
    or more arguments. It is an implementation bug but it breaks backword
    compatibility.

* REXML::Parsers::StreamParser
  * Supports "entity" event.

* REXML::Text
  * REXML::Text#<< supports method chain like 'text << "XXX" << "YYY"'.
  * REXML::Text#<< supports not "raw" mode.

* Rinda::RingServer, Rinda::RingFinger
  * Rinda now supports multicast sockets.  See Rinda::RingServer and
    Rinda::RingFinger for details.

* RubyGems
  * Updated to 2.2.0.preview.1  For a list of enhancements and bug fixes see:
    https://github.com/rubygems/rubygems/blob/v2.2.0.preview.1/History.txt

* Set
  * New methods:
    * Set#intersect?
    * Set#disjoint?

* Socket
  * New methods:
    * Socket.getifaddrs

* StringScanner
  * extended methods:
    * StringScanner#[] supports named captures.

* Syslog::Logger
  * Added facility.

* Tempfile
  * New methods:
    * Tempfile.create


* WEBrick
  * The body of a response may now be a StringIO or other IO-like that responds
    to #readpartial and #read.

* XMLRPC::Client
  * New methods:
    * XMLRPC::Client#http. It returns Net::HTTP for the client. Normally,
      it is not needed. It is useful when you want to change minor HTTP client
      options. You can change major HTTP client options by XMLRPC::Client
      methods. You should use XMLRPC::Client methods for changing major
      HTTP client options instead of XMLRPC::Client#http.


=== Stdlib compatibility issues (excluding feature bug fixes)

<span id="objspace-in-news">* objspace
  * new method:
    * ObjectSpace.trace_object_allocations
    * ObjectSpace.trace_object_allocations_start
    * ObjectSpace.trace_object_allocations_stop
    * ObjectSpace.trace_object_allocations_clear
    * ObjectSpace.allocation_sourcefile
    * ObjectSpace.allocation_sourceline
    * ObjectSpace.allocation_class_path
    * ObjectSpace.allocation_method_id
    * ObjectSpace.allocation_generation</span>

* Set
  * incompatible changes:
    * Set#to_set now returns self instead of generating a copy.

* URI
  * incompatible changes:
    * URI.decode_www_form follows current WHATWG URL Standard.
      It gets encoding argument to specify the character encoding.
      It now allows loose percent encoded strings, but denies ;-separator.
    * URI.encode_www_form follows current WHATWG URL Standard.
      It gets encoding argument to convert before percent encode.
      UTF-16 strings aren't converted to UTF-8 before percent encode by default.


=== Built-in global variables compatibility issues

* $SAFE
  * $SAFE=4 is obsolete.  If $SAFE is set to 4 or larger, an ArgumentError
    is raised.
  </pre>
  <pre class="news-big-big fragment slow" id="objspace-big-big">* objspace
  * new method:
    <span style="color: yellow; font-weight: bold;">* ObjectSpace.trace_object_allocations</span>
    * ObjectSpace.trace_object_allocations_start
    * ObjectSpace.trace_object_allocations_stop
    * ObjectSpace.trace_object_allocations_clear
    * ObjectSpace.allocation_sourcefile
    * ObjectSpace.allocation_sourceline
    * ObjectSpace.allocation_class_path
    * ObjectSpace.allocation_method_id
    * ObjectSpace.allocation_generation
    </pre>
</section>

<section data-markdown data-state="default">
  <script type="text/template">
    ## ObjectSpace is not new

    Mostly known for

    * `ObjectSpace.count_objects`
    * `ObjectSpace.each_object`
    * `ObjectSpace.garbage_collect`

    <footer>
      [\[rubydoc.info\]](http://rubydoc.info/stdlib/core/ObjectSpace)
    </footer>
  </script>
</section>

<section data-state="default">
  <h3>ObjectSpace.new_in_ruby_2_1</h3>

  <ul>
    <li><code>ObjectSpace.trace_object_allocations</code></li>
    <li style="color: #BBB; margin-top: 0.2em;"><code>ObjectSpace.trace_object_allocations_start</code><sup>*</sup></li>
    <li style="color: #BBB; margin-top: 0.2em;"><code>ObjectSpace.trace_object_allocations_stop</code><sup>*</sup></li>
    <li style="color: #BBB; margin-top: 0.2em;"><code>ObjectSpace.trace_object_allocations_clear</code><sup>*</sup></li>
    <li style="color: #BBB; margin-top: 0.2em;"><code>...</code></li>
  </ul>

  <p style="text-align: right; margin-top: 1em;">
    <sup>*</sup>
    <a href="https://github.com/ruby/ruby/commit/1450e0b5ac0a49aa1f0d1db521b293b18f6fa99c">2.1.0-preview2</a>
  </p>
</section>

<section data-state="default">
  <h2>Anecdote from GitHub</h2>

  <pre style="font-size: 0.9em;"><code class="ruby">GitHub.preload_all
GC.start
count = ObjectSpace.count_objects

puts count[:TOTAL] - count[:FREE]
#=> 605183</code></pre>

  <h3>&gt; 600k Ruby objects!</h3>

  <footer>
    <a href="https://github.com/blog/1489-hey-judy-don-t-make-it-bad">[github blog]</a>
  </footer>
</section>

<section data-state="default">
  <h2 style="line-height: 1.3;">"Where am I supposedly hogging all this memory?"</h2>
</section>

<section id="ex1" data-state="default" class="hilights">
  <h3>Enter <code>::trace_object_allocations</code></h3>

  <pre class="fragment" id="ex1-1"><code class="ruby" data-trim>
# example.rb

1  class MyClass
2    def an_array
3      return [2,3,5,7,11,13,17,19,23,29,31]
4    end

5    def a_string
6      return "a String"
7    end
8  end
  </code></pre>

  <div class="fragment-parent">
    <pre class="fragment slower"
         id="ex1-2"
         style="position: absolute"><code class="ruby" data-trim data-noescape>
require 'objspace'

a = s = nil

<div data-hilight-idx="1" class="hi">ObjectSpace.trace_object_allocations do
  a = MyClass.new.an_array
  s = MyClass.new.a_string
end</div>

<div data-hilight-idx="2" class="hi">ObjectSpace.allocation_sourcefile(a) #=&gt; "example.rb"
ObjectSpace.allocation_sourceline(a) #=&gt; 3
ObjectSpace.allocation_class_path(a) #=&gt; "MyClass"
ObjectSpace.allocation_method_id(a)  #=&gt; "an_array"

ObjectSpace.allocation_sourcefile(s) #=&gt; "example.rb"
ObjectSpace.allocation_sourceline(s) #=&gt; 6
ObjectSpace.allocation_class_path(s) #=&gt; "MyClass"
ObjectSpace.allocation_method_id(s)  #=&gt; "a_string"</div>
    </code></pre>
    <span class="fragment" data-hilight-idx="1" style="display: none;"></span>
    <span class="fragment" data-hilight-idx="2" style="display: none;"></span>

    <pre class="fragment slow"
         id="ex1-3"
         data-hilight-idx="3"><code class="ruby" data-trim data-noescape>
require 'objspace'



<div data-hilight-idx="3" class="hi">ObjectSpace.trace_object_allocations_start
a = MyClass.new.an_array
s = MyClass.new.a_string
ObjectSpace.trace_object_allocations_stop</div>

ObjectSpace.allocation_sourcefile(a) #=&gt; "example.rb"
ObjectSpace.allocation_sourceline(a) #=&gt; 3
ObjectSpace.allocation_class_path(a) #=&gt; "MyClass"
ObjectSpace.allocation_method_id(a)  #=&gt; "an_array"

ObjectSpace.allocation_sourcefile(s) #=&gt; "example.rb"
ObjectSpace.allocation_sourceline(s) #=&gt; 6
ObjectSpace.allocation_class_path(s) #=&gt; "MyClass"
ObjectSpace.allocation_method_id(s)  #=&gt; "a_string"
    </code></pre>
  </div>
</section>

<section data-state="default">
  <h1>Why?</h1>
  <ul>
    <li class="fragment">Reduce memory footprint</li>
    <li class="fragment">
      Reduce garbage collection time
      <ul><li class="fragment">(marking and sweeping)</li></ul>
    </li>
  </ul>
</section>

<section data-state="default">
  <h2 style="line-height: 1.3;">But my application isn't on Ruby 2.1!</h2>
  <h3 style="line-height: 1.3;">That's okay! It's a <em>diagnostic</em> tool!</h3>
</section>

<section data-state="default">
  <h3>ObjectSpace.trace_object_allocations</h3>
  <h2>is</h2>
  <h1>
    <span class="fragment slow fade-out" data-fragment-index="1" style="position: absolute;">Limited</span>
    <span class="fragment slow fade-in" data-fragment-index="1" style="position: absolute;">
      <span class="fragment slow fade-out" data-fragment-index="2">Fine-Grained</span>
    </span>
  <span class="fragment slow fade-in" data-fragment-index="2">Just the Start</span>
  </h1>
</section>

<section data-state="teal-bg">
  <h2>The Next Step:</h2>
  <h1>Aggregation</h1>
</section>

<section data-state="teal-bg">
  <h1>AllocationStats</h1>

  <footer>
    <a href="https://github.com/srawlins/allocation_stats">[github]</a>
  </footer>
</section>

<section data-state="teal-bg" id="ex2" class="hilights">
  <h3>Low-level Example</h3>

  <div class="code">
    <pre><code class="ruby" data-noescape> 1  class MyClass
 2    def my_method
<div data-hilight-idx="2" class="hi"> 3      @hash = {2 => "foo", 3 => "bar", 5 => "baz"}</div>
<div data-hilight-idx="1" class="hi"> 4      @string = "quux"</div>
 5    end
 6  end</code></pre>

    <pre><code class="fragment ruby" data-noescape> 7
 8  require "allocation_stats"
 9  stats = AllocationStats.trace do
<div data-hilight-idx="3" class="hi">10    MyClass.new.my_method</div>
11  end</code></pre>

    <pre><code class="fragment ruby">12
13  puts stats.allocations.to_text</code></pre>
  </div>

  <pre class="fragment"><code class="no-highlight" data-noescape>           sourcefile             sourceline  class_path  method_id   class
--------------------------------  ----------  ----------  ---------  -------
<div data-hilight-idx="1" class="hi">./examples/trace_my_class_raw.rb           4  MyClass     my_method  String</div>
<div data-hilight-idx="2" class="hi">./examples/trace_my_class_raw.rb           3  MyClass     my_method  Hash
./examples/trace_my_class_raw.rb           3  MyClass     my_method  String
./examples/trace_my_class_raw.rb           3  MyClass     my_method  String
./examples/trace_my_class_raw.rb           3  MyClass     my_method  String</div>
<div data-hilight-idx="3" class="hi">./examples/trace_my_class_raw.rb          10  Class       new        MyClass</div>
</code></pre>

  <span class="fragment" data-hilight-idx="1" style="display: none;"></span>
  <span class="fragment" data-hilight-idx="2" style="display: none;"></span>
  <span class="fragment" data-hilight-idx="3" style="display: none;"></span>
</section>

<section data-state="teal-bg" id="ex3" class="hilights">
  <h3>group_by Example</h3>

  <div class="code">
    <pre><code class="ruby" data-noescape> 1  class MyClass
 2    def my_method
<div data-hilight-idx="2" class="hi"> 3      @hash = {2 => "foo", 3 => "bar", 5 => "baz"}</div>
 4      @string = "quux"
 5    end
 6  end</code></pre>

    <pre class="fragment"><code class="ruby" data-noescape> 7
 8  require "allocation_stats"
 9  stats = AllocationStats.trace do
10    MyClass.new.my_method
11  end</pre></code>

    <pre class="fragment" style="font-size: 0.55em;"><code class="ruby" data-noescape>12
13  puts stats.allocations<div data-hilight-idx="1" class="hi">.group_by(:sourcefile, :sourceline, :class)</div>.to_text</code></pre>
  </div>
  <span class="fragment" data-hilight-idx="1" style="display: none;"></span>

  <pre class="fragment"><code class="no-highlight" data-noescape>             sourcefile                sourceline   class   count
-------------------------------------  ----------  -------  -----
./examples/trace_my_class_group_by.rb           4  String       1
./examples/trace_my_class_group_by.rb           3  Hash         1
<div data-hilight-idx="2" class="hi">./examples/trace_my_class_group_by.rb           3  String       3</div>
./examples/trace_my_class_group_by.rb          10  MyClass      1</code></pre>

  <span class="fragment" data-hilight-idx="2" style="display: none;"></span>
</section>

<section data-state="teal-bg">
  <h2>Psych</h2>

  <pre><code class="ruby" data-noescape>require "yaml"
require "allocation_stats"

stats = AllocationStats.trace do
  # lots of objects from Rbconfig::CONFIG["rubylibdir"]
  y = YAML.dump(["one string", "two string"])
end

puts stats.allocations(alias_paths: true).group_by(:sourcefile, :class).to_text</code></pre>

  <pre class="fragment"><code class="no-highlight" data-noescape>               sourcefile                             class               count
----------------------------------------  ------------------------------  -----
&lt;RUBYLIBDIR&gt;/psych/visitors/visitor.rb    String                             38
&lt;RUBYLIBDIR&gt;/psych/visitors/visitor.rb    MatchData                           5
&lt;RUBYLIBDIR&gt;/psych/visitors/visitor.rb    Regexp                              1
&lt;RUBYLIBDIR&gt;/psych/visitors/emitter.rb    Psych::Emitter                      1
&lt;RUBYLIBDIR&gt;/psych/visitors/emitter.rb    Array                               2
&lt;RUBYLIBDIR&gt;/psych/nodes/node.rb          Psych::Visitors::Emitter            1
&lt;RUBYLIBDIR&gt;/psych/nodes/node.rb          StringIO                            1
&lt;RUBYLIBDIR&gt;/psych/nodes/node.rb          String                              3
&lt;RUBYLIBDIR&gt;/psych/tree_builder.rb        Psych::Nodes::Scalar                2
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb  Array                              12
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb  Method                              5
&lt;RUBYLIBDIR&gt;/psych/scalar_scanner.rb      String                              5
&lt;RUBYLIBDIR&gt;/psych/scalar_scanner.rb      MatchData                           2
...</code></pre>
</section>

<section data-state="teal-bg">
  <h2>Psych - sorted</h2>

  <pre><code class="ruby" data-noescape>require "yaml"
require "allocation_stats"

stats = AllocationStats.trace do
  # lots of objects from Rbconfig::CONFIG["rubylibdir"]
  y = YAML.dump(["one string", "two string"])
end

puts stats.allocations(alias_paths: true).
  group_by(:sourcefile, :class).
  sort_by_count.
  to_text</code></pre>

  <pre class="fragment"><code class="no-highlight" data-noescape>               sourcefile                             class               count
-----------------------------------------  ------------------------------  -----
&lt;RUBYLIBDIR&gt;/psych/visitors/visitor.rb     String                             38
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb   String                             21
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb   Array                              12
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb   Method                              5
&lt;RUBYLIBDIR&gt;/psych/scalar_scanner.rb       String                              5
&lt;RUBYLIBDIR&gt;/psych/visitors/visitor.rb     MatchData                           5
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb   Hash                                3
&lt;RUBYLIBDIR&gt;/psych/nodes/node.rb           String                              3
&lt;RUBYLIBDIR&gt;/psych/nodes/node.rb           Array                               3
&lt;RUBYLIBDIR&gt;/psych/visitors/yaml_tree.rb   MatchData                           3
&lt;RUBYLIBDIR&gt;/psych/visitors/emitter.rb     String                              3
...</code></pre>
</section>

<section data-state="teal-bg" class="hilights">
  <h2>class_plus</h2>

  <pre class="fragment-parent"
       data-nm8-css="{ 'left': '-3.5em', 'opacity': 0.6 }"
       ><code class="ruby" data-noescape>require 'hike'
require 'allocation_stats'

stats = AllocationStats.trace do
  path = $:.detect { |p| p =~ /hike/ }
  path = File.dirname(path)

  trail = Hike::Trail.new path
  trail.append_extension ".rb"
  trail.append_paths "lib"

  trail.find("hike")
end

puts stats.allocations(alias_paths: true)
          .group_by(<div data-hilight-idx="1" class="hi">:sourcefile, :class_plus</div>)
          .sort_by_count
          .to_text</code></pre>

  <span class="fragment" data-hilight-idx="1" style="display: none;"></span>

  <pre class="fragment"
       style="font-size: 0.51em;"
       data-nm8-css="{ 'top': '-17em', 'left': '2.5em' }"
       ><code class="no-highlight" data-noescape>                   sourcefile                              class_plus           count
-------------------------------------------------  ---------------------------  -----
<div data-hilight-idx="3" class="hi red">&lt;RUBYLIBDIR&gt;/rubygems/core_ext/kernel_require.rb   String                         438</div>
&lt;RUBYLIBDIR&gt;/pathname.rb                           String                         152
<div data-hilight-idx="3" class="hi red"><div data-hilight-idx="2" class="hi">&lt;RUBYLIBDIR&gt;/rubygems/core_ext/kernel_require.rb   Array&lt;Fixnum,FalseClass&gt;       134</div>
&lt;RUBYLIBDIR&gt;/rubygems/core_ext/kernel_require.rb   RubyVM::InstructionSequence    105</div>
examples/hike_hike.rb                              String                          81
<div data-hilight-idx="2" class="hi">&lt;RUBYLIBDIR&gt;/pathname.rb                           Array&lt;String&gt;                   67</div>
&lt;RUBYLIBDIR&gt;/pathname.rb                           String                          67
<div data-hilight-idx="3" class="hi red"><div data-hilight-idx="2" class="hi">&lt;RUBYLIBDIR&gt;/rubygems/core_ext/kernel_require.rb   Array&lt;Array&gt;                    58</div>
&lt;RUBYLIBDIR&gt;/rubygems/core_ext/kernel_require.rb   Array                           47
&lt;RUBYLIBDIR&gt;/rubygems.rb                           String                          27</div>
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb         String                          21
<div data-hilight-idx="3" class="hi red">examples/hike_hike.rb                              RubyVM::InstructionSequence     20</div>
&lt;RUBYLIBDIR&gt;/pathname.rb                           String                          20
examples/hike_hike.rb                              Array                           16
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb         String                          15
...</code></pre>

  <span class="fragment" data-hilight-idx="2" style="display: none;"></span>
  <span class="fragment" data-hilight-idx="3" style="display: none;"></span>
</section>

<section data-state="teal-bg" class="hilights">
  <h2>burn</h2>

  <pre class="fragment-parent"
       data-nm8-css="{ 'left': '-3.5em', 'opacity': 0.6 }"
       ><code class="ruby" data-noescape>require 'hike'
require 'allocation_stats'

stats = AllocationStats.new<div data-hilight-idx="1" class="hi">(burn: 1)</div>.trace do
  path = $:.detect { |p| p =~ /hike/ }
  path = File.dirname(path)

  trail = Hike::Trail.new path
  trail.append_extension ".rb"
  trail.append_paths "lib"

  trail.find("hike")
end

puts stats.allocations(alias_paths: true)
          .group_by(:sourcefile, :class_plus)
          .sort_by_count
          .to_text</code></pre>

  <span class="fragment" data-hilight-idx="1" style="display: none;"></span>

  <pre class="fragment"
       data-nm8-css="{ 'top': '-17em', 'left': '3em' }"
       ><code class="no-highlight" data-noescape>                     sourcefile                          class_plus     count
-----------------------------------------------------  ---------------  -----
&lt;RUBYLIBDIR&gt;/pathname.rb                               String             287
&lt;RUBYLIBDIR&gt;/pathname.rb                               Array&lt;String&gt;       73
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             String              73
&lt;RUBYLIBDIR&gt;/pathname.rb                               MatchData           13
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             Pathname            12
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             Array&lt;Pathname&gt;     11
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/paths.rb             String               7
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             Array&lt;String&gt;        6
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             MatchData            6
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/trail.rb             String               6
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/trail.rb             Array&lt;String&gt;        5
&lt;GEMDIR&gt;/gems/hike-1.2.3/lib/hike/index.rb             Hash                 5
...</code></pre>
</section>

<section data-state="blue-bg">
  <h2>Object Churn</h2>
  <h3 class="fragment" style="margin-top: 2em;">Expensive Garbage Collection</h3>
  <h3 class="fragment" style="margin-top: 1em;">per-Rack::Request allocations</h3>
</section>

<section data-state="blue-bg">
  <h2><em style="font-size: 1.45em;">Rack</em> AllocationStats</h2>

  <footer>
    <a href="https://github.com/srawlins/rack-allocation_stats">[github]</a>
  </footer>
</section>

<section data-state="blue-bg">
  <h2>Rack Middleware</h2>
  <div class="left half">http://my.rack.app:9292</div>
  <div class="right half">/path<br />?foo=bar<br /><span class="fragment">&amp;<em>ras[trace]=true</em></span></p>
</section>

<section data-state="blue-bg" id="sinatra-app">
  <h2 class="trans">
    <span id="sin1-h2">A Simple Sinatra App</span>
    <span id="sin2-h2" style="position: absolute; left: 0; display: none;">localhost:9292/erb</span>
    <span id="sin3-h2" style="position: absolute; left: 0; display: none;">localhost:9292/erb<span style="color: #FFFF66;">?ras[trace]=true</span></span>
    &nbsp;
  </h2>

  <div style="position: relative;">
    <div class="code sinatra-app" id="sin1">
      <pre><code class="ruby" data-noescape>class SinatraTemplatesApp &lt; Sinatra::Base
  HELLOS = ["Hello", "Hola", "Bonjour", "Gutentag",
            "こんにちは", "привет"]

  enable :inline_templates

  get "/erb" do
    erb :erb
  end
end

__END__

@@ erb</code></pre>
    <pre><code class="xml">&lt;html&gt;
  &lt;body&gt;
    &lt;ul id="hi"&gt;
      &lt;% HELLOS.each do |hello| %&gt;
        &lt;li class="greeting"&gt;&lt;%= hello %&gt; World!&lt;/li&gt;
      &lt;% end %&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
    </div>
    <img src="img/ras_01.png"
         class="fragment"
         id="sin2"
         style="position: absolute;"
         data-nm8-css="{ 'top': '-0.7em', 'left': '-0.7em' }"
         data-nm8-class="pause-0-3" />
    <img src="img/ras_trace_01.png"
         class="fragment"
         id="sin3"
         data-nm8-css="{ 'top': '0.4em', 'left': '2.3em' }"
         data-nm8-class="pause-0-3" />
    </div>
</section>

<section data-state="blue-bg" class="no-shadow">
  <h2>?ras[help]</h2>

  <pre>Rack AllocationStats help

Append ras[trace]=true to your URL to trace all object allocations during the
request. The server will respond with statistics on the allocations, instead of
the application's response.

Options

ras[times]=COUNT
    send the request to the application COUNT times, to reduce statistics from
    initial allocations that don't happen on repeat requests.

ras[help]
    immediately respond with this help text

ras[scope]=SCOPE
    limits the list of allocations in the response to those whose `sourcefile`
    matches SCOPE. `ras[scope]='.'` is a special case which is expanded to be
    the current working directory.

...</pre>
</section>

<section data-state="blue-bg">
  <h2>?ras[alias_paths]=true</h2>

  <img src="img/ras_trace_01.png" style="width: 90%;" />
</section>

<section data-state="blue-bg">
  <h2>?ras[times]=10</h2>
</section>

<section data-state="blue-bg">
  <h2>?ras[output]=json</h2>
  <pre class="fragment-parent"
       data-nm8-css="{ 'left': '-3em', 'opacity': 0.6 }"
       ><code class="no-highlight" style="word-wrap: break-word;">[{"group_key":["/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb",445,"String"],"allocations":[{"memsize":0,"class_path":"String","method_id":"scan","file":"&lt;RUBYLIBDIR&gt;/erb.rb","file (raw)":"/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb","line":445,"class":"String","class_plus":"String"},{"memsize":0,"class_path":"String","method_id":"scan","file":"&lt;RUBYLIBDIR&gt;/erb.rb","file (raw)":"/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb","line":445,"class":"String","class_plus":"String"},{"memsize":0,"class_path":"String","method_id":"scan","file":"&lt;RUBYLIBDIR&gt;/erb.rb","file (raw)":"/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb","line":445,"class":"String","class_plus":"String"},{"memsize":0,"class_path":"String","method_id":"scan","file":"&lt;RUBYLIBDIR&gt;/erb.rb","file (raw)":"/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb","line":445,"class":"String","class_plus":"String"},...</code></pre>

  <pre class="fragment"
       style="width: 93%;"
       data-nm8-css="{ 'top': '-12em', 'left': '3em' }"
       ><code class="json" style="max-height: 430px;">[
  { "group_key": [
      "/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb",
      445,
      "String"
    ],
    "allocations": [
      { "memsize": 0,
        "class_path": "String",
        "method_id": "scan",
        "file": "&lt;RUBYLIBDIR&gt;/erb.rb",
        "file (raw)": "/usr/local/rbenv/versions/2.1.0-dev/lib/ruby/2.1.0/erb.rb",
        "line": 445,
        "class": "String",
        "class_plus": "String" },
      ...
    ]
  },
  ...
]</code></pre>
</section>

<section data-state="blue-bg">
  <section>
    <h2>?ras[output]=interactive</h2>
  </section>

  <section>
    <h3>?ras[output]=interactive</h3>
    <img src="img/ras-interactive-01.png" />
  </section>

  <section>
    <h3>?ras[output]=interactive</h3>
    <img src="img/ras-interactive-02.png" />
  </section>
</section>

<!--section data-state="blue-bg">
  <section>
    <h2>Simple Sinatra App</h2>
    <img src="img/ras-sinatra.png" />
  </section>

  <section>
    <h3>Sinatra App w/ /haml</h3>
    <img src="img/ras-sinatra-haml.png" />
  </section>

  <section>
    <h3>Sinatra App w/ /slim</h3>
    <img src="img/ras-sinatra-slim.png" />
  </section>
</section-->

<section data-state="blue-bg">
  <h2>What do I do???</h2>
  <h3 class="fragment" style="margin-top: 1em;">Allocate less.</h3>
</section>

<section data-state="blue-bg">
  <h2>How do I allocate less?</h2>
  <h3 class="fragment" style="margin-top: 1em;">That depends :)</h3>
</section>

<section data-state="blue-bg">
  <p>Use self-modifying collection methods where possible.</p>
  <pre><code class="no-highlight" data-noescape>diff --git a/lib/temple/hash.rb b/lib/temple/hash.rb
index a2235c0..f1e5a70 100644
--- a/lib/temple/hash.rb
+++ b/lib/temple/hash.rb
@@ -24,3 +24,3 @@ def each
     def keys
<span style="color: red;">-      @hash.inject([]) {|keys, h| keys<span style="background-color: rgba(255,0,0,0.2);"> += h.keys</span> }.uniq</span>
<span style="color: #00FF00;">+      @hash.inject([]) {|keys, h| keys<span style="background-color: rgba(0,255,0,0.2);">.concat(h.keys)</span> }.uniq</span>
     end</code></pre>

  <footer>
    <a href="https://github.com/judofyr/temple/pull/75/files">[judofyr/temple #75]</a><br />
    <a href="http://rubydoc.info/stdlib/core/Array#concat-instance_method">[ Array#concat ]</a><br />
    <a href="http://rubydoc.info/stdlib/core/Array#%2B-instance_method">[ Array#+ ]</a>
  </footer>
</section>

<section data-state="blue-bg">
  <h2>Memoization</h2>
  <p class="fragment">(String interpolation and concatenation)</p>
</section>

<section data-state="blue-bg">
  <section>
    <h1>Rails 3.2.15</h1>
  </section>

  <section>
    <h3>Rails 3.2.15</h3>
    <img src="img/ras-rails-3.2.15-01.png" />
  </section>

  <section>
    <h3>Rails 3.2.15</h3>
    <img src="img/ras-rails-3.2.15-02.png" />
  </section>
</section>

<section data-state="blue-bg">
  <section>
    <h1>Rails 3.2.15</h1>
    <h3>
      <a href="https://github.com/rails/rails/blob/v3.2.15/activesupport/lib/active_support/callbacks.rb#L80" target="_blank">lib/active_support/callbacks.rb</a>
    </h3>
    <pre><code class="ruby" data-trim>
&nbsp;80  def run_callbacks(kind, *args, &block)
 81    send("_run_#{kind}_callbacks", *args, &block)
 82  end

...

413  def __callback_runner_name(key, kind)
414    "_run__#{self.name.hash.abs}__#{kind}__#{key.hash.abs}__callbacks"
415  end
    </code></pre>
  </section>

  <section>
    <h1>Rails 4.0.0</h1>
    <h3>
      <a href="https://github.com/rails/rails/blob/v4.0.0/activesupport/lib/active_support/callbacks.rb#L383" target="_blank">lib/active_support/callbacks.rb</a>
    </h3>
    <pre><code class="ruby" data-trim>
383  def __callback_runner_name_cache
384    @__callback_runner_name_cache ||= ThreadSafe::Cache.new {|cache, kind|
                             cache[kind] = __generate_callback_runner_name(kind) }
385  end
386
387  def __generate_callback_runner_name(kind)
388    "_run__#{self.name.hash.abs}__#{kind}__callbacks"
389  end
390
391  def __callback_runner_name(kind)
392    __callback_runner_name_cache[kind]
393  end
    </code></pre>
  </section>
</section>

<section data-state="blue-bg">
  <section>
    <h1>Rails 3.2.15</h1>
    <h3>
      <a href="https://github.com/rails/rails/blob/v3.2.15/activerecord/lib/active_record/relation.rb#L6" target="_blank">active_record/relation.rb</a>
    </h3>
    <pre><code class="ruby" data-trim>
ASSOCIATION_METHODS = [:includes, :eager_load, :preload]
MULTI_VALUE_METHODS = [:select, :group, :order, :joins, :where, :having, :bind]
SINGLE_VALUE_METHODS = [:limit, :offset, :lock, :readonly, :from, :reordering,
                                                           :reverse_order, :uniq]

def initialize(klass, table)

  ...

  SINGLE_VALUE_METHODS.each {|v| instance_variable_set(:"@#{v}_value", nil)}
  (ASSOCIATION_METHODS + MULTI_VALUE_METHODS).each {|v|
                                      instance_variable_set(:"@#{v}_values", [])}

  ...

end
    </code></pre>
  </section>
</section>

<section data-state="blue-bg">
  <h2>Not Always Easy</h2>
  <p>
    <a href="https://github.com/rails/rails/blob/v3.2.15/activesupport/lib/active_support/core_ext/string/output_safety.rb#L184" target="_blank">active_support/core_ext/string/output_safety.rb:184</a>
  </p>
  <pre><code class="ruby" data-noescape>class SafeBuffer &lt; String
  def initialize(*)
    @html_safe = true
    super
  end
end

class String
  def html_safe
    ActiveSupport::SafeBuffer.new(self) <span style="color: red;">&lt;== line 184</span>
  end
end</code></pre>
</section>

<section data-state="blue-bg">
  <h2>Not Always Easy</h2>
  <p>
    <a href="https://github.com/rails/rails/blob/v4.0.1/actionpack/lib/action_view/helpers/tag_helper.rb#L66" target="_blank">action_view/helpers/tag_helper.rb:66</a>
  </p>
  <pre style="width: 93%;"><code class="ruby" data-noescape>def tag(name, options = nil, open = false, escape = true)
  "<#{name}#{tag_options(options, escape) if options}#{open ? ">" : "/>"}".html_safe
end</code></pre>
</section>

<section data-state="blue-bg">
  <h2>Not Always Easy</h2>
  <p>
    <a href="https://github.com/sparklemotion/sqlite3-ruby/blob/v1.3.8/lib/sqlite3/statement.rb#L108" target="_blank">sqlite3/statement.rb:108</a>
  </p>
  <pre><code class="ruby" data-noescape>def each
  loop do
    val = step    <span style="color: red;">&lt;== line 108</span>
    break self if done?
    yield val
  end
end</code></pre>
  <ul>
    <li class="fragment">Where is <code>#step</code>?</li>
    <li class="fragment">
      It's an 88-line C function in
      <a
      href="https://github.com/sparklemotion/sqlite3-ruby/blob/v1.3.8/ext/sqlite3/statement.c#L107" target="_blank">ext/sqlite3/statement.c</a>
      :(
    </li>
  </ul>
</section>

<section data-state="default">
  <h2>Things to Google</h2>
  <ul>
    <li class="fragment">github blog hey judy</li>
    <li class="fragment">ruby allocation_stats</li>
    <li class="fragment">ruby rack-allocation_stats</li>
    <li class="fragment">koichi sasada efficient 2.1</li>
  </ul>
</section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>
    <script src="js/jquery-2.0.3.min.js"></script>

    <script>

// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
  controls: true,
  progress: true,
  history: true,
  center: true,

  theme: 'night' || Reveal.getQueryHash().theme, // available themes are in /css/theme
  transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

  // Optional libraries used to extend on reveal.js
  dependencies: [
    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
    { src: 'plugin/highlight/highlight-reveal.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
  ]
});

Reveal.addEventListener('default', function() {
  $("body").delay(650);
  $.queue($("body")[0], "fx", function() {
    $(this).css({ backgroundColor: '' });
    jQuery.dequeue(this);
  });
}, false );

Reveal.addEventListener('teal-bg', function() {
  $("body").delay(650);
  $.queue($("body")[0], "fx", function() {
    $(this).css({ backgroundColor: 'teal' });
    jQuery.dequeue(this);
  });
}, false );

Reveal.addEventListener('blue-bg', function() {
  $("body").delay(650);
  $.queue($("body")[0], "fx", function() {
    $(this).css({ backgroundColor: '#002147' });
    jQuery.dequeue(this);
  });
}, false );

Reveal.addEventListener( 'fragmentshown', function(event) {
  var fragment = $(event.fragment);

  if (fragment.parents('#ex1').length > 0) {
    if (fragment.attr('id') == 'ex1-2') { show_ex1_2(); }
    if (fragment.attr('id') == 'ex1-3') { show_ex1_3(); }
  }

  if (fragment.attr('id') == 'objspace-big-big') { show_big_big(); }

  if (fragment.parents('.hilights').length > 0 && fragment.data('hilight-idx')) {
    hilight(fragment);
  }

  if (fragment.data('nm8-css')) { nm8_show(fragment); }

  if (fragment.attr('id') == 'sin2') { sin2_show(fragment); }
  if (fragment.attr('id') == 'sin3') { sin3_show(fragment); }
});

Reveal.addEventListener( 'fragmenthidden', function(event) {
  var fragment = $(event.fragment);

  if (fragment.parents('#ex1').length > 0) {
    if (fragment.attr('id') == 'ex1-2') { hide_ex1_2(); }
    if (fragment.attr('id') == 'ex1-3') { hide_ex1_3(); }
  }

  if (fragment.attr('id') == 'objspace-big-big') { hide_big_big(); }

  if (fragment.parents('.hilights').length > 0 && fragment.data('hilight-idx')) {
    lolight(fragment);
  }

  if (fragment.data('nm8-css')) { nm8_hide(fragment); }

  if (fragment.attr('id') == 'sin2') { sin2_hide(fragment); }
  if (fragment.attr('id') == 'sin3') { sin3_hide(fragment); }
});

function nm8_show(el) {
  var prev = el.prevAll("*[data-nm8-css]");

  if (prev.length > 0) {
    prev = $(prev[prev.length - 1]);
    var prevStyle = $.parseJSON(prev.data('nm8-css').replace(/'/g, '\"'));
    prev.css(prevStyle);
    if (prev.data('nm8-class')) { prev.removeClass(prev.data('nm8-class')); }
  }

  var style = $.parseJSON(el.data('nm8-css').replace(/'/g, '\"'));
  el.css(style);
  if (el.data('nm8-class')) { el.addClass(el.data('nm8-class')); }
}

function nm8_hide(el) {
  var prev = el.prevAll("*[data-nm8-css]");

  if (prev.length > 0) {
    prev = $(prev[prev.length - 1]);
    var prevStyle = $.parseJSON(prev.data('nm8-css').replace(/'/g, '\"'));
    for (key in prevStyle) { prev.css(key, ''); }
    if (prev.data('nm8-class')) { prev.addClass(prev.data('nm8-class')); }
  }

  var style = $.parseJSON(el.data('nm8-css').replace(/'/g, '\"'));
  for (key in style) { el.css(key, ''); }
  if (el.data('nm8-class')) { el.removeClass(el.data('nm8-class')); }
}

function show_ex1_2() {
  $('#ex1-1').css({ left: '-3em', opacity: 0.6 });
  $('#ex1-2').parent().css({ top: '-4em', left: '3.5em' });
}

function hide_ex1_2() {
  $('#ex1-1').css({ left: '', opacity: '' });
  $('#ex1-2').css({ top: '', left: '' });
}

function show_ex1_3() { $('#ex1-2').css({ opacity: 0 }); }
function hide_ex1_3() { $('#ex1-2').css({ opacity: '' }); }

function show_big_big() {
  var objspaceInNews = $('#objspace-in-news'),
      objspaceBigBig = $('#objspace-big-big'),
      newsPre = objspaceInNews.parent(),
      newsMarginLeft = (newsPre.outerWidth(true) - newsPre.width()) / 2,
      newsMarginTop = (newsPre.outerHeight(true) - newsPre.height()) / 2,
      newsCenter = newsMarginLeft + newsPre.width() / 2,
      newsMiddle = newsMarginTop + newsPre.position().top + newsPre.height() / 2;

  objspaceBigBig.css('left',
    objspaceInNews.position().left + newsMarginLeft);
  objspaceBigBig.css('top',
    objspaceInNews.position().top + newsPre.position().top + newsMarginTop);

  objspaceBigBig.show();
  newsPre.css('opacity', 0.3);

  objspaceBigBig.css({
    left: newsCenter - objspaceInNews.width()/2,
    top: newsMiddle - objspaceInNews.height()/2
  });

  objspaceBigBig.delay(750);

  $.queue(objspaceBigBig[0], "fx", function() {
    $(this).css({
      fontSize: '0.80em',
      lineHeight: '1.5em',
      left: newsMarginLeft,
      top: newsPre.position().top,
    });
    jQuery.dequeue(this);
  });
}

function hide_big_big() {
  var objspaceInNews = $('#objspace-in-news'),
      objspaceBigBig = $('#objspace-big-big'),
      newsPre = objspaceInNews.parent();

  newsPre.css('opacity', 1.0);

  objspaceBigBig.delay(750);

  $.queue(objspaceBigBig[0], "fx", function() {
    $(this).hide();
    $(this).css({
      fontSize: '',
      lineHeight: '',
      left: '',
      top: ''
    });
    jQuery.dequeue(this);
  });
}

function hilight(el) {
  var idx = el.data('hilight-idx');
  el.parents(".hilights").find("div[data-hilight-idx]").removeClass("light");
  el.parents(".hilights").find("div[data-hilight-idx='" + idx + "']").addClass("light");
}

function lolight(el) {
  var idx = el.data('hilight-idx');
  el.parents(".hilights").find("div[data-hilight-idx]").removeClass("light");
  el.parents(".hilights").find("div[data-hilight-idx='" + (idx-1) + "']").addClass("light");
}

function sin2_show(el) {
  $('#sin1').css({ opacity: '0.5' });
  $('#sin1-h2').fadeOut();
  $('#sin2-h2').fadeIn();
}

function sin3_show(el) {
  $('#sin1').css({ opacity: '0.3' });
  $('#sin2').css({ opacity: '0.7' });
  el.closest('section').find('h2')
    .delay(700)
    .queue(function() { $(this).css({ fontSize: '1.2em' }).dequeue(); })
    .delay(700)
    .queue(function() {
      $('#sin2-h2').fadeOut();
      $('#sin3-h2').fadeIn();
      $(this).dequeue();
    });
}

function sin2_hide(el) {
  $('#sin1').css({ opacity: '' });
  $('#sin2-h2').fadeOut();
  $('#sin1-h2').fadeIn();
}

function sin3_hide(el) {
  $('#sin1').css({ opacity: '0.5' });
  $('#sin2').css({ opacity: '' });
  el.closest('section').find('h2')
    .delay(100)
    .queue(function() {
      $('#sin3-h2').fadeOut();
      $('#sin2-h2').fadeIn();
      $(this).dequeue();
    })
    .delay(700)
    .queue(function() { $(this).css('font-size', '').dequeue(); });
}
    </script>

  </body>
</html>
